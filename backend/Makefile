.PHONY: help up down restart logs ps clean rebuild test api-logs db-logs migrate-logs swagger

# ========================================
# Dockerç’°å¢ƒï¼ˆæ¨å¥¨ï¼‰
# ========================================

## ç’°å¢ƒã®èµ·å‹•ãƒ»åœæ­¢

# Dockerç’°å¢ƒèµ·å‹•ï¼ˆDB + ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ + APIï¼‰
up:
	@echo "ğŸ³ Starting Docker environment..."
	docker-compose up -d
	@echo "âœ… Docker environment started!"
	@echo ""
	@echo "ğŸ“ API: http://localhost:8080"
	@echo "ğŸ“š Swagger UI: http://localhost:8080/swagger"
	@echo "ğŸ—„ï¸  PostgreSQL: localhost:5432"

# Dockerç’°å¢ƒåœæ­¢
down:
	@echo "ğŸ›‘ Stopping Docker environment..."
	docker-compose down
	@echo "âœ… Docker environment stopped!"

# Dockerç’°å¢ƒå†èµ·å‹•
restart:
	@echo "ğŸ”„ Restarting Docker environment..."
	docker-compose restart
	@echo "âœ… Docker environment restarted!"

# Dockerç’°å¢ƒåœæ­¢ + ãƒœãƒªãƒ¥ãƒ¼ãƒ å‰Šé™¤ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆï¼‰
clean:
	@echo "âš ï¸  Stopping Docker and removing volumes..."
	docker-compose down -v
	@echo "âœ… Docker environment and volumes removed!"

# Dockerç’°å¢ƒãƒªãƒ“ãƒ«ãƒ‰ + èµ·å‹•
rebuild:
	@echo "ğŸ”¨ Rebuilding and starting Docker environment..."
	docker-compose down
	docker-compose up -d --build
	@echo "âœ… Docker environment rebuilt and started!"

## ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°è¡¨ç¤ºï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
logs:
	docker-compose logs -f

# APIã®ãƒ­ã‚°ã®ã¿è¡¨ç¤º
api-logs:
	docker-compose logs -f api

# PostgreSQLã®ãƒ­ã‚°ã®ã¿è¡¨ç¤º
db-logs:
	docker-compose logs -f postgres

# Flywayãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°è¡¨ç¤º
migrate-logs:
	docker-compose logs flyway

# ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª
ps:
	docker-compose ps

## ãƒ†ã‚¹ãƒˆãƒ»é–‹ç™º

# Swagger UIã‚’é–‹ã
swagger:
	@echo "ğŸŒ Opening Swagger UI..."
	@open http://localhost:8080/swagger || xdg-open http://localhost:8080/swagger || start http://localhost:8080/swagger

# ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
test:
	@echo "ğŸ§ª Creating sample course..."
	@curl -s -X POST http://localhost:8080/api/courses \
	  -H "Content-Type: application/json" \
	  -d '{"courseCode":"CS101","name":"Introduction to Computer Science","credits":3,"maxCapacity":50}' | jq .
	@echo ""
	@echo "ğŸ“š Listing all courses..."
	@curl -s http://localhost:8080/api/courses | jq .

# ========================================
# ãƒ˜ãƒ«ãƒ—
# ========================================

help:
	@echo "ğŸ“š University Management System - Makefile Commands"
	@echo ""
	@echo "ğŸ³ Dockerç’°å¢ƒï¼ˆæ¨å¥¨ï¼‰:"
	@echo "  make up          - Dockerç’°å¢ƒã‚’èµ·å‹•ï¼ˆDB + ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ + APIï¼‰"
	@echo "  make down        - Dockerç’°å¢ƒã‚’åœæ­¢"
	@echo "  make restart     - Dockerç’°å¢ƒã‚’å†èµ·å‹•"
	@echo "  make rebuild     - Dockerç’°å¢ƒã‚’ãƒªãƒ“ãƒ«ãƒ‰ + èµ·å‹•"
	@echo "  make clean       - Dockerç’°å¢ƒã‚’åœæ­¢ + ãƒœãƒªãƒ¥ãƒ¼ãƒ å‰Šé™¤"
	@echo ""
	@echo "ğŸ“Š ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°:"
	@echo "  make logs        - å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã‚’è¡¨ç¤º"
	@echo "  make api-logs    - APIã®ãƒ­ã‚°ã‚’è¡¨ç¤º"
	@echo "  make db-logs     - PostgreSQLã®ãƒ­ã‚°ã‚’è¡¨ç¤º"
	@echo "  make migrate-logs - Flywayãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°ã‚’è¡¨ç¤º"
	@echo "  make ps          - ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ç¢ºèª"
	@echo ""
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»é–‹ç™º:"
	@echo "  make swagger     - Swagger UIã‚’é–‹ã"
	@echo "  make test        - ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦APIã‚’ãƒ†ã‚¹ãƒˆ"
	@echo ""
	@echo "ğŸ’¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ:"
	@echo "  1. make up       - ç’°å¢ƒã‚’èµ·å‹•"
	@echo "  2. make swagger  - Swagger UIã§APIã‚’ç¢ºèª"
	@echo "  3. make test     - ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ"
	@echo "  4. make down     - ç’°å¢ƒã‚’åœæ­¢"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.DEFAULT_GOAL := help
